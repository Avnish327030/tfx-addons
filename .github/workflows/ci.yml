name: GitHub CI

on:
  push:
    branches:
      - main
      - r*
  pull_request:
    branches:
      - main
      - r*

jobs:
  build:
    if: github.actor != 'copybara-service[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - uses: actions/checkout@v2
    - name: Get Changed Files
      id: changed_files
      uses: trilom/file-changes-action@v1.2.3
      with:
        fileOutput: ' '
    - name: Select files to check
      run: |
        # Filter out non-python files.
        (cat $HOME/files_added.txt; echo; cat $HOME/files_modified.txt) | tr ' ' '\n' | grep '\.py$' > py_files.txt || true
        # Filter out non-test python files and e2e or integration tests.
        cat py_files.txt | grep '_test\.py$' | grep -v _e2e_ | grep -v integration | grep -v 'examples/' > py_test_files.txt || true
        # Select proto files.
        (cat $HOME/files_added.txt; echo; cat $HOME/files_modified.txt) | tr ' ' '\n' | grep '\.proto$' > proto_files.txt || true
    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel
        pip install -e .[all]
    - name: Run pre-commit
      run: |
        pre-commit run

  #   name: Notebook format
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/setup-python@v1
  #   - uses: actions/checkout@v2
  #   - name: Install tensorflow-docs
  #     run: python3 -m pip install -U git+https://github.com/tensorflow/docs
  #   - name: Check notebook formatting
  #     run: |
  #       # Run on all notebooks to prevent upstream change.
  #       echo "Check formatting with nbfmt:"
  #       python3 -m tensorflow_docs.tools.nbfmt --test \
  #           $(find docs/tutorials/ -type f -name *.ipynb)
  # nblint:
  #   name: Notebook lint
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/setup-python@v1
  #   - uses: actions/checkout@v2
  #   - name: Install tensorflow-docs
  #     run: python3 -m pip install -U git+https://github.com/tensorflow/docs
  #   - name: Lint notebooks
  #     run: |
  #       # Run on all notebooks to prevent upstream change.
  #       echo "Lint check with nblint:"
  #       python3 -m tensorflow_docs.tools.nblint \
  #           --arg=repo:tensorflow/addons \
  #           $(find docs/tutorials/ -type f -name *.ipynb ! -path "docs/tutorials/_template.ipynb")